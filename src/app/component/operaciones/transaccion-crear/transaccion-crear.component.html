<div class="container" style="padding: 20px; max-width: 600px; margin: 0 auto;">
  <h2>Realizar Pago</h2>

  <!-- SELECTOR DE TIPO DE TRANSACCIÓN -->
  <div style="margin-bottom: 24px; padding: 16px; background: #f5f5f5; border-radius: 8px;">
    <label style="display: block; margin-bottom: 12px; font-weight: 500; color: #333;">
      ¿Qué deseas hacer?
    </label>

    <div style="display: flex; gap: 16px;">
      <button type="button" mat-raised-button [color]="tipoTransaccion === 'comercio' ? 'primary' : ''"
        (click)="onTipoTransaccionChange('comercio')" style="flex: 1;">
        <mat-icon>store</mat-icon>
        Pagar a Comercio
      </button>

      <button type="button" mat-raised-button [color]="tipoTransaccion === 'p2p' ? 'primary' : ''"
        (click)="onTipoTransaccionChange('p2p')" style="flex: 1;">
        <mat-icon>send</mat-icon>
        Transferir a Usuario
      </button>
    </div>
  </div>

  <form [formGroup]="form" (ngSubmit)="guardar()">

    <!-- DESTINATARIO: COMERCIO O EMAIL -->
    <mat-form-field appearance="outline" style="width: 100%;" *ngIf="tipoTransaccion === 'comercio'">
      <mat-label>Comercio Destino</mat-label>
      <mat-select formControlName="comercioId">
        <mat-option *ngFor="let c of comercios" [value]="c.comercioId">
          {{ c.nombreComercial }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 100%;" *ngIf="tipoTransaccion === 'p2p'">
      <mat-label>Email del Destinatario</mat-label>
      <input matInput type="email" [(ngModel)]="emailDestinatario" [ngModelOptions]="{standalone: true}"
        (blur)="validarDestinatarioP2P($event)" placeholder="usuario@ejemplo.com">
      <mat-icon matPrefix>person</mat-icon>

      <mat-spinner *ngIf="validandoDestinatario" diameter="20" matSuffix></mat-spinner>

      <mat-hint *ngIf="usuarioDestinatario && !errorDestinatario" style="color: green;">
        ✓ {{usuarioDestinatario.nombre}} {{usuarioDestinatario.apellido}}
      </mat-hint>

      <mat-error *ngIf="errorDestinatario">
        {{errorDestinatario}}
      </mat-error>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 100%;">
      <mat-label>Criptomoneda a usar</mat-label>
      <mat-select formControlName="criptoId">
        <mat-option *ngFor="let cry of criptos" [value]="cry.criptoId">
          {{ cry.nombre }} ({{ cry.codigo }})
        </mat-option>
      </mat-select>

      <!-- Mostrar saldo disponible EN CRIPTO -->
      <mat-hint *ngIf="saldoDisponibleCripto > 0 && tasaCambioActual > 0">
        Saldo: <strong>{{ saldoDisponibleCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada }}</strong>
        (≈ ${{ montoMaximoUSD | number:'1.2-2' }} USD)
      </mat-hint>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 100%;">
      <mat-label>Método de Pago</mat-label>
      <mat-select formControlName="metodoPagoId">
        <mat-option *ngFor="let m of metodos" [value]="m.metodoPagoId">
          {{ m.nombre }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" style="width: 100%;">
      <mat-label>Monto a Pagar (USD)</mat-label>
      <input matInput type="number" formControlName="montoTotalFiat" step="0.01">
      <span matTextPrefix>$&nbsp;</span>

      <!-- Mostrar conversión en tiempo real -->
      <mat-hint *ngIf="montoEnCripto > 0 && !tieneSaldoInsuficiente" style="color: #1976d2;">
        Estás pagando aprox. <strong>{{ montoEnCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada }}</strong>
      </mat-hint>

      <!-- Mensaje de error de saldo insuficiente -->
      <mat-error *ngIf="tieneSaldoInsuficiente">
        Saldo insuficiente. Necesitas <strong>{{ montoEnCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada
          }}</strong>
        pero solo tienes <strong>{{ saldoDisponibleCripto | number:'1.2-8' }}</strong>
      </mat-error>

      <!-- Mensaje de error de monto mínimo -->
      <mat-error *ngIf="form.get('montoTotalFiat')?.hasError('min') && !tieneSaldoInsuficiente">
        El monto debe ser mayor a $0.01
      </mat-error>
    </mat-form-field>

    <!-- Información de tasa de cambio -->
    <div *ngIf="tasaCambioActual > 0"
      style="padding: 12px; background-color: #e3f2fd; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
      <p style="margin: 0; font-size: 13px; color: #0d47a1;">
        <strong>Tasa de cambio actual:</strong> 1 {{ codigoCriptoSeleccionada }} = ${{ tasaCambioActual |
        number:'1.2-2' }} USD
      </p>
    </div>

    <!-- Alerta de saldo insuficiente MÁS VISIBLE -->
    <div *ngIf="tieneSaldoInsuficiente"
      style="padding: 15px; background-color: #ffebee; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #f44336;">
      <p style="margin: 0 0 8px 0; font-size: 14px; color: #c62828; font-weight: 500;">
        <strong>Saldo Insuficiente</strong>
      </p>
      <p style="margin: 0; font-size: 13px; color: #c62828;">
        • <strong>Monto en USD:</strong> ${{ form.get('montoTotalFiat')?.value | number:'1.2-2' }}<br>
        • <strong>Equivalente en cripto:</strong> {{ montoEnCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada
        }}<br>
        • <strong>Tu saldo actual:</strong> {{ saldoDisponibleCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada
        }}<br>
        • <strong>Te faltan:</strong> {{ (montoEnCripto - saldoDisponibleCripto) | number:'1.2-8' }} {{
        codigoCriptoSeleccionada }}
      </p>
    </div>

    <!-- Resumen del pago (cuando el saldo es suficiente) -->
    <div *ngIf="montoEnCripto > 0 && !tieneSaldoInsuficiente && form.valid"
      style="padding: 15px; background-color: #e8f5e9; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #4caf50;">
      <p style="margin: 0 0 8px 0; font-size: 14px; color: #2e7d32; font-weight: 500;">
        <strong>Resumen del Pago</strong>
      </p>
      <p style="margin: 0; font-size: 13px; color: #2e7d32;">
        • <strong>Pagarás:</strong> ${{ form.get('montoTotalFiat')?.value | number:'1.2-2' }} USD<br>
        • <strong>Usando:</strong> {{ montoEnCripto | number:'1.2-8' }} {{ codigoCriptoSeleccionada }}<br>
        • <strong>Saldo restante:</strong> {{ (saldoDisponibleCripto - montoEnCripto) | number:'1.2-8' }} {{
        codigoCriptoSeleccionada }}
      </p>
    </div>

    <!-- Información general -->
    <div
      style="padding: 12px; background-color: #fff8e1; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #FFC107;">
      <p style="margin: 0; font-size: 13px; color: #F57F17;">
        <strong>Nota:</strong> La conversión se realiza usando la tasa de cambio más reciente del sistema.
        El cálculo es automático y se actualiza en tiempo real.
      </p>
    </div>

    <div style="display: flex; gap: 10px; justify-content: flex-end;">
      <button mat-button type="button" routerLink="/transacciones">Cancelar</button>
      <button mat-raised-button color="primary" type="submit" [disabled]="form.invalid || guardando">
        {{ guardando ? 'Procesando...' : 'Procesar Pago' }}
      </button>
    </div>

  </form>
</div>